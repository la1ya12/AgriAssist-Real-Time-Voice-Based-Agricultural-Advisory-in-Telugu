<!DOCTYPE html>
<html lang="te">
<head>
  <meta charset="UTF-8">
  <title>ЁЯМ╛ р░др▒Жр░▓р▒Бр░Чр▒Б р░░р▒Ир░др▒Б р░╕р░╣р░╛р░пр░Хр▒Бр░бр▒Б</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="overlay">
    <div class="chat-container">
      <h2>ЁЯМ╛ р░др▒Жр░▓р▒Бр░Чр▒Б р░░р▒Ир░др▒Б р░╕р░╣р░╛р░пр░Хр▒Бр░бр▒Б</h2>

      <div id="chat-box" class="chat-box">
        <div class="bot-msg">ЁЯСйтАНЁЯТ╗ р░ир░ор░╕р▒Нр░др▒З р░░р▒Ир░др▒Б р░Чр░╛р░░р▒Б! р░ир▒Зр░ир▒Б р░ор▒А р░╕р░╣р░╛р░пр░Хр▒Бр░бр▒Б. р░ор░╛р░Яр▒Нр░▓р░╛р░бр░Вр░бр░┐...</div>
      </div>

      <div class="input-area">
        <input id="userText" type="text" placeholder="р░ор▒А р░╕р░Вр░жр▒Зр░╢р░В р░░р░╛р░пр░Вр░бр░┐ р░▓р▒Зр░жр░╛ р░ор▒Ир░Хр▒Н р░жр▒Нр░╡р░╛р░░р░╛ р░ор░╛р░Яр▒Нр░▓р░╛р░бр░Вр░бр░┐..." />
        <button id="micBtn">ЁЯОд р░ор▒Ир░Хр▒Н р░Жр░ир▒Н</button>
        <button id="sendBtn">ЁЯУи р░кр░Вр░кр░Вр░бр░┐</button>
      </div>

      <audio id="responseAudio" controls hidden></audio>
    </div>
  </div>

  <script>
    const micBtn = document.getElementById('micBtn');
    const sendBtn = document.getElementById('sendBtn');
    const chatBox = document.getElementById('chat-box');
    const userText = document.getElementById('userText');
    const responseAudio = document.getElementById('responseAudio');

    // Append messages
    function appendMessage(sender, text) {
      const msg = document.createElement('div');
      msg.className = sender === 'user' ? 'user-msg' : 'bot-msg';
      msg.textContent = text;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Send typed message
    sendBtn.onclick = async () => {
      const text = userText.value.trim();
      if (!text) return;
      appendMessage('user', text);
      userText.value = '';

      const formData = new FormData();
      formData.append('text', text);

      const res = await fetch('/voice', { method: 'POST', body: formData });
      const data = await res.json();
      appendMessage('bot', data.text);
      responseAudio.src = data.audio + "?t=" + new Date().getTime(); // cache-busting
      responseAudio.hidden = false;
      responseAudio.play();
    };

    // Voice recognition (Telugu)
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "te-IN";
    recognition.interimResults = false;

    micBtn.onclick = () => {
      recognition.start();
      micBtn.textContent = "ЁЯОЩ р░╡р░┐р░ир░┐р░кр░┐р░╕р▒Нр░др▒Лр░Вр░жр░┐...";
    };

    recognition.onresult = async (event) => {
      const text = event.results[0][0].transcript;
      appendMessage('user', text);

      const formData = new FormData();
      formData.append('text', text);

      const res = await fetch('/voice', { method: 'POST', body: formData });
      const data = await res.json();
      appendMessage('bot', data.text);
      responseAudio.src = data.audio + "?t=" + new Date().getTime();
      responseAudio.hidden = false;
      responseAudio.play();

      micBtn.textContent = "ЁЯОд р░ор▒Ир░Хр▒Н р░Жр░ир▒Н";
    };

    recognition.onerror = (e) => {
      micBtn.textContent = "ЁЯОд р░ор▒Ир░Хр▒Н р░Жр░ир▒Н";
      appendMessage('bot', "р░Хр▒Нр░╖р░ор░┐р░Вр░Ър░Вр░бр░┐, р░╡р░╛р░пр░┐р░╕р▒Н р░Чр▒Бр░░р▒Нр░др░┐р░Вр░Ър░▓р▒Зр░Хр░кр▒Лр░пр░╛р░ир▒Б.");
    };
  </script>
</body>
</html>
